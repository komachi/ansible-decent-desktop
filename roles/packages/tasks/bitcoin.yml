- name: Ensure we don't have globally installed electrum
  package:
    name: electrum
    state: absent

- name: Install electrum from flatpak
  flatpak:
    name: org.electrum.electrum
    state: present

- name: Ensures ~/.var/app/org.electrum.electrum/.electrum exists
  file:
    path: "/home/{{ username }}/.var/app/org.electrum.electrum/.electrum"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"

- name: Configure electrum
  copy:
    src: 'electrum/config'
    dest: "/home/{{ username }}/.var/app/org.electrum.electrum/.electrum/config"
    mode: 0640
    owner: "{{ username }}"
    group: "{{ username }}"

- name: Gather package facts
  package_facts:
    manager: auto

- name: Create temp dir for wasabiwallet
  tempfile:
    state: directory
  register: wasabiwallet_download_tempdir
  when: "('wassabee' not in ansible_facts.packages) or ('wassabee' in ansible_facts.packages and ansible_facts.packages.wassabee[0].version != wasabiwallet_version)"

- name: Download wasabi wallet
  get_url:
    url: "https://github.com/zkSNACKs/WalletWasabi/releases/download/v{{ wasabiwallet_version_full }}/Wasabi-{{ wasabiwallet_version }}.deb"
    dest: "{{ wasabiwallet_download_tempdir.path }}/wasabi.deb"
    checksum: "{{ wasabiwallet_checksum }}"
  when: "('wassabee' not in ansible_facts.packages) or ('wassabee' in ansible_facts.packages and ansible_facts.packages.wassabee[0].version != wasabiwallet_version)"

- name: Install wasabi wallet
  apt:
    deb: "{{ wasabiwallet_download_tempdir.path }}/wasabi.deb"
  when: "('wassabee' not in ansible_facts.packages) or ('wassabee' in ansible_facts.packages and ansible_facts.packages.wassabee[0].version != wasabiwallet_version)"

- name: Remove tempdir
  file:
    path: "{{ wasabiwallet_download_tempdir.path }}"
    state: absent
  when: "('wassabee' not in ansible_facts.packages) or ('wassabee' in ansible_facts.packages and ansible_facts.packages.wassabee[0].version != wasabiwallet_version)"

- name: Ensures ~/.walletwasabi/client exists
  file:
    path: "/home/{{ username }}/.walletwasabi/client"
    state: directory
    owner: "{{ username }}"
    group: "{{ username }}"

- name: Configure wasabi wallet ui
  copy:
    src: 'walletwasabi/UiConfig.json'
    dest: "/home/{{ username }}/.walletwasabi/client/UiConfig.json"
    owner: "{{ username }}"
    group: "{{ username }}"